<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>項目排序與管理工具</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 SortableJS CDN for drag and drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* 使用 Inter 字體 */
        body { font-family: 'Inter', sans-serif; }

        /* 項目 2: 拖曳視覺優化 - 占位符/拖曳中的項目 */
        .sortable-ghost {
            opacity: 0.5;
            background-color: #f3f4f6; /* 淡灰背景 */
        }
        
        .sortable-ghost > td {
            visibility: hidden; /* 隱藏所有內容 */
            padding: 0 !important;
            height: 0;
            line-height: 0;
            border-top: 3px solid #3b82f6; /* 粗藍色線 */
        }

        .sortable-chosen {
            background-color: #e0f2fe; /* light-blue-100 */
            border: 2px solid #3b82f6; /* blue-500 */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transform: scale(1.01);
            transition: transform 0.15s ease-in-out;
        }

        /* 項目 4: 刪除淡出動畫 */
        .item-deleting {
            opacity: 0;
            transform: translateX(100%);
            max-height: 0;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            transition: all 0.5s ease-in-out;
        }
        
        /* 自定義滾動條 */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c7d2fe;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a5b4fc;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- 全局狀態/錯誤訊息提示 (Toast) -->
    <div id="statusMessage" class="hidden fixed bottom-4 right-4 bg-green-500 text-white p-3 rounded-xl shadow-xl z-50 transition duration-300 transform translate-x-0" style="min-width: 250px;">
        <!-- Message will be inserted here -->
    </div>

    <!-- 項目 1: 輸入區塊 -->
    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 shadow-lg">
        <div class="max-w-4xl mx-auto p-4 sm:p-6">
            <div class="flex items-center mb-2">
                <svg class="w-8 h-8 text-white mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                </svg>
                <h1 class="text-2xl font-extrabold text-white">
                    項目排序與管理工具
                </h1>
            </div>
            <p class="text-sm text-indigo-100 mb-4">您的數據已自動保存至瀏覽器存儲。</p>
            
            <!-- 新增/批次模式切換區塊 -->
            <div class="bg-white p-4 rounded-xl shadow-lg border border-indigo-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">
                        新增項目 / 批次編輯
                    </h2>
                    <!-- 項目 7: 批次編輯模式切換按鈕 -->
                    <button onclick="toggleBatchMode()" id="batchModeToggle" class="px-3 py-1 text-sm rounded-full transition duration-150 shadow-md font-medium bg-indigo-600 text-white hover:bg-indigo-700 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        切換到批次編輯模式
                    </button>
                </div>
                
                <div id="addModeForm" class="grid grid-cols-1 sm:grid-cols-4 gap-4 items-end">
                    <!-- ****** 這裡已替換為下拉式選單 ****** -->
                    <div class="sm:col-span-2">
                        <label for="newItemName" class="block text-xs font-medium text-gray-700 mb-1">項目名稱</label>
                        <select id="newItemName" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <!-- 選項將由 JavaScript 填充 -->
                        </select>
                    </div>
                    <!-- ************************************ -->

                    <div>
                        <label for="newPosition" class="block text-xs font-medium text-gray-700 mb-1">新增位置 (選填)</label>
                        <input type="number" id="newPosition" placeholder="自動加在最後" min="1" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button onclick="addItem()" class="w-full bg-indigo-600 text-white p-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md flex items-center justify-center">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        新增項目
                    </button>
                </div>
                
                <!-- 項目 7: 批次編輯控制面板 -->
                <div id="batchModeControls" class="hidden flex flex-wrap gap-3 mt-4">
                    <button onclick="batchDelete()" class="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition shadow-md disabled:opacity-50 flex items-center" id="batchDeleteBtn" disabled>
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        批次刪除 (0)
                    </button>
                    <div class="flex items-center space-x-2 bg-gray-100 p-2 rounded-lg">
                        <label for="batchMovePosition" class="text-sm font-medium text-gray-700">移動至位置:</label>
                        <input type="number" id="batchMovePosition" min="1" class="w-20 p-1 border border-gray-300 rounded-lg text-center text-sm">
                        <button onclick="batchMove()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600 transition shadow-md disabled:opacity-50 flex items-center" id="batchMoveBtn" disabled>
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                            </svg>
                            移動
                        </button>
                    </div>
                    <!-- 修正：批次上下按鈕改為純圖示 -->
                    <button onclick="batchShift('up')" class="px-4 py-2 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600 transition shadow-md disabled:opacity-50 flex items-center" id="batchUpBtn" disabled>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                        </svg>
                        <span class="sr-only">批次上移</span>
                    </button>
                    <button onclick="batchShift('down')" class="px-4 py-2 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600 transition shadow-md disabled:opacity-50 flex items-center" id="batchDownBtn" disabled>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                        <span class="sr-only">批次下移</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 主要內容區塊 -->
    <div class="max-w-4xl mx-auto p-4 sm:p-8">
        <!-- 項目清單展示區塊 -->
        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-indigo-100">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                    </svg>
                    目前的項目排序
                </h2>
                
                <!-- 新增：存檔和取消按鈕 -->
                <div class="flex space-x-2">
                    <button id="saveButton" class="px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition shadow-md flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        存檔
                    </button>
                    <button id="cancelButton" class="px-4 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition shadow-md flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        取消
                    </button>
                </div>
            </div>
            
            <!-- 警告/提示訊息 -->
            <div id="loadingMessage" class="flex items-center justify-center p-4 text-indigo-600 font-medium">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                正在載入您的項目...
            </div>

            <!-- 項目表格/列表 -->
            <div id="itemsListContainer" class="overflow-x-auto">
                <!-- 列表將由 JavaScript 渲染到這裡 -->
            </div>
            
            <p id="emptyState" class="hidden text-gray-400 text-center py-8 flex flex-col items-center">
                <svg class="w-16 h-16 mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                目前沒有任何項目。請在上方新增您的第一個項目！
            </p>
        </div>
        
        <!-- 使用說明 -->
        <div class="mt-8 bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-indigo-100">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">使用說明</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-medium text-blue-700 mb-2">基本操作</h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• 從下拉選單選擇項目並點擊「新增項目」</li>
                        <li>• 拖放項目進行排序</li>
                        <li>• 使用上下箭頭按鈕移動項目</li>
                        <li>• 點擊刪除按鈕移除項目</li>
                    </ul>
                </div>
                <div class="p-4 bg-purple-50 rounded-lg">
                    <h3 class="font-medium text-purple-700 mb-2">進階功能</h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• 切換到批次編輯模式進行多項目操作</li>
                        <li>• 使用 Ctrl/Cmd + ↑/↓ 快速移動項目</li>
                        <li>• 指定位置新增項目</li>
                        <li>• 批次移動和刪除項目</li>
                        <li>• 使用「存檔」按鈕保存更改</li>
                        <li>• 使用「取消」按鈕還原至上一次存檔狀態</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- 分享區塊 -->
        <div class="mt-8 bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-indigo-100">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                </svg>
                分享這個工具
            </h2>
            <p class="text-gray-600 mb-4">複製以下連結與他人分享這個項目排序工具：</p>
            <div class="flex items-center">
                <input type="text" id="shareLink" value="https://example.com/project-sorter" readonly class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:ring-indigo-500 focus:border-indigo-500">
                <button onclick="copyShareLink()" class="bg-indigo-600 text-white p-2 rounded-r-lg font-semibold hover:bg-indigo-700 transition duration-150 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    複製連結
                </button>
            </div>
        </div>
    </div>

    <!-- 網站功能腳本 -->
    <script>
        // 全域變數
        let currentItems = [];
        let isAuthReady = false;
        let sortableInstance = null;
        let lastSavedItems = []; // 用於記錄最後一次存檔的狀態
        
        // 項目 7: 批次模式相關狀態
        let isBatchMode = false;
        let selectedItemIds = new Set();
        let focusedItemId = null; // 項目 5: 用於鍵盤排序追蹤
        
        // ****** 修改：更新預設項目清單 ******
        const predefinedItems = [
            "新手引導",
            "新手禮包",
            "登入月禮",
            "好運蛋",
            "付費蛋",
            "回流任務",
            "活動任務",
            "公告"
        ];
        
        // 模擬本地存儲
        const STORAGE_KEY = 'projectItems';
        
        /**
         * 顯示 Toast 狀態訊息 (替代 alert)
         * @param {string} message - 要顯示的訊息
         * @param {'success'|'error'|'info'} type - 訊息類型
         */
        function showStatusMessage(message, type = 'success') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-yellow-500');
            
            if (type === 'error') {
                statusDiv.classList.add('bg-red-500');
            } else if (type === 'info') {
                statusDiv.classList.add('bg-yellow-500');
            } else {
                statusDiv.classList.add('bg-green-500');
            }

            statusDiv.classList.remove('opacity-0', 'translate-x-full');
            statusDiv.classList.add('opacity-100', 'translate-x-0');

            setTimeout(() => {
                statusDiv.classList.remove('opacity-100', 'translate-x-0');
                statusDiv.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => statusDiv.classList.add('hidden'), 300); 
            }, 3000);
        }
        window.showStatusMessage = showStatusMessage;

        /**
         * 填充項目名稱下拉選單
         */
        function populateDropdown() {
            const select = document.getElementById('newItemName');
            
            // 加入預設的禁用選項
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "請選擇一個項目";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            select.appendChild(defaultOption);

            predefinedItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                select.appendChild(option);
            });
        }
        
        /**
         * 模擬從本地存儲載入數據
         */
        function loadItemsFromStorage() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                currentItems = JSON.parse(stored);
                lastSavedItems = JSON.parse(stored); // 初始化最後保存的狀態
            }
            
            // 模擬載入延遲
            setTimeout(() => {
                document.getElementById('loadingMessage').classList.add('hidden');
                renderList();
            }, 1000);
        }
        
        /**
         * 模擬保存數據到本地存儲
         */
        function saveItemsToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(currentItems));
            lastSavedItems = JSON.parse(JSON.stringify(currentItems)); // 深拷貝當前狀態
            showStatusMessage("項目已成功存檔！", 'success');
        }
        
        /**
         * 取消操作 - 還原到最後一次存檔的狀態
         */
        function cancelChanges() {
            currentItems = JSON.parse(JSON.stringify(lastSavedItems)); // 深拷貝最後保存的狀態
            renderList();
            showStatusMessage("已還原至最後一次存檔的狀態！", 'info');
        }
        
        /**
         * 複製分享連結
         */
        function copyShareLink() {
            const shareLink = document.getElementById('shareLink');
            shareLink.select();
            shareLink.setSelectionRange(0, 99999); // 對於行動裝置
            document.execCommand("copy");
            showStatusMessage("連結已複製到剪貼簿！", 'success');
        }

        // 項目 5: 鍵盤排序事件監聽器
        document.addEventListener('keydown', (e) => {
            if (!isAuthReady) return; // 再次檢查連線狀態
            
            // Ctrl (或 Cmd) + Up/Down
            if (e.ctrlKey || e.metaKey) { 
                if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                    if (focusedItemId) {
                        e.preventDefault(); // 阻止頁面捲動
                        const direction = e.key === 'ArrowUp' ? 'up' : 'down';
                        
                        // 確保只有非批次模式下才能使用鍵盤移動單個項目
                        if (!isBatchMode) {
                            moveItem(focusedItemId, direction);
                            
                            // 移動後重新設置 focus 到新位置的項目
                            setTimeout(() => {
                                const targetElement = document.getElementById(`item-row-${focusedItemId}`);
                                if (targetElement) {
                                    targetElement.focus();
                                }
                            }, 100); 
                        } else {
                            // 在批次模式下，使用鍵盤來移動選中項目
                            batchShift(direction);
                        }
                    }
                }
            }
        });

        /**
         * 渲染項目列表到 DOM
         */
        function renderList() {
            const container = document.getElementById('itemsListContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (currentItems.length === 0) {
                // *** FIX: 如果清單為空，先銷毀 Sortable 實例 ***
                if (sortableInstance) {
                    sortableInstance.destroy();
                    sortableInstance = null;
                }
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            // *** FIX: 在 DOM 被覆寫 (innerHTML) 之前，銷毀現有的 Sortable 實例 ***
            if (sortableInstance) {
                sortableInstance.destroy();
                sortableInstance = null;
            }
            // *******************************************************************
            
            const checkboxHeader = isBatchMode ? `<th class="px-2 py-3 text-left w-[40px]"><input type="checkbox" onchange="toggleSelectAll(this.checked)" class="rounded text-indigo-600"></th>` : '';
            const handleHeader = isBatchMode ? '' : `<th class="px-2 py-3 text-center w-[40px] text-gray-500">☰</th>`;
            const dragClass = isBatchMode ? '' : 'cursor-move';

            let html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="bg-gray-50">
                            ${checkboxHeader}
                            ${handleHeader}
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">排序</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-6/12">項目名稱</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-5/12">動作</th>
                        </tr>
                    </thead>
                    <tbody id="sortableItems" class="bg-white divide-y divide-gray-200">
            `;

            currentItems.forEach((item, index) => {
                const isFirst = index === 0;
                const isLast = index === currentItems.length - 1;
                const isSelected = selectedItemIds.has(item.id);
                const isFocused = focusedItemId === item.id;
                
                const checkboxCell = isBatchMode ? `
                    <td class="px-2 py-4 whitespace-nowrap text-sm text-center">
                        <input type="checkbox" onchange="toggleSelection('${item.id}', this.checked)" 
                               ${isSelected ? 'checked' : ''} class="rounded text-indigo-600 focus:ring-indigo-500">
                    </td>` : '';

                const handleCell = isBatchMode ? '' : `
                    <td class="px-2 py-4 whitespace-nowrap text-sm text-center">
                        <span class="drag-handle text-gray-400 hover:text-indigo-600 transition cursor-grab text-lg">☰</span>
                    </td>`;

                html += `
                    <tr id="item-row-${item.id}" data-id="${item.id}" 
                        tabindex="0" 
                        onclick="focusedItemId = '${item.id}';" 
                        onfocus="focusedItemId = '${item.id}';"
                        class="
                            ${dragClass} 
                            hover:bg-indigo-50 transition duration-100 
                            ${isFocused && !isBatchMode ? 'ring-2 ring-indigo-300' : ''}
                        ">
                        ${checkboxCell}
                        ${handleCell}
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${item.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="moveItem('${item.id}', 'up')" 
                                        ${isFirst || isBatchMode ? 'disabled' : ''} 
                                        class="p-2 rounded-full text-indigo-600 hover:bg-indigo-100 transition duration-150 ${isFirst || isBatchMode ? 'opacity-50 cursor-not-allowed' : ''}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                                    <span class="sr-only">往上</span>
                                </button>
                                <button onclick="moveItem('${item.id}', 'down')" 
                                        ${isLast || isBatchMode ? 'disabled' : ''} 
                                        class="p-2 rounded-full text-indigo-600 hover:bg-indigo-100 transition duration-150 ${isLast || isBatchMode ? 'opacity-50 cursor-not-allowed' : ''}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    <span class="sr-only">往下</span>
                                </button>
                                <button onclick="deleteItem('${item.id}')" 
                                        ${isBatchMode ? 'disabled' : ''}
                                        class="p-2 rounded-full text-red-600 hover:bg-red-100 transition duration-150 ${isBatchMode ? 'opacity-50 cursor-not-allowed' : ''}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    <span class="sr-only">刪除</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
            
            // 只有在非批次模式下才啟用拖曳
            if (!isBatchMode) {
                initializeSortable();
            }
            
            updateBatchControls();
        }
        window.renderList = renderList;

        /**
         * 初始化 SortableJS 拖曳功能
         */
        function initializeSortable() {
            const list = document.getElementById('sortableItems');
            if (!list || typeof Sortable === 'undefined') return; 

            // *** FIX: 這裡不需要再銷毀，因為 renderList 已經處理了 ***

            sortableInstance = Sortable.create(list, {
                animation: 250,
                handle: '.drag-handle', 
                ghostClass: 'sortable-ghost', 
                chosenClass: 'sortable-chosen', 
                onEnd: function (evt) {
                    if (evt.oldIndex !== evt.newIndex) {
                        const listElement = document.getElementById('sortableItems');
                        const newIdSequence = Array.from(listElement.children).map(tr => tr.getAttribute('data-id'));
                        reorderItems(newIdSequence); // 使用整個新順序
                    }
                },
            });
        }

        /**
         * 處理拖曳排序後的項目更新
         */
        async function reorderItems(newIdSequence) {
            try {
                // 更新項目順序
                const newItems = [];
                newIdSequence.forEach((itemId, newPos) => {
                    const item = currentItems.find(i => i.id === itemId);
                    if (item) {
                        item.order = newPos + 1;
                        newItems.push(item);
                    }
                });
                
                // 重新排序 currentItems
                currentItems = newItems.sort((a, b) => a.order - b.order);
                
                console.log("項目拖曳排序成功。");
                showStatusMessage("拖曳排序成功。", 'success');
                
                // 重新渲染列表以顯示更新後的順序
                renderList();
            } catch (e) {
                console.error("拖曳排序項目時發生錯誤: ", e);
                showStatusMessage("拖曳排序失敗，請查看控制台錯誤訊息。", 'error');
            }
        }
        window.reorderItems = reorderItems;
        
        /**
         * 新增項目
         */
        async function addItem() {
            // ****** 更改為從 <select> 讀取值 ******
            const nameSelect = document.getElementById('newItemName');
            const positionInput = document.getElementById('newPosition');
            const itemName = nameSelect.value.trim(); 
            // ************************************
            let targetOrder = parseInt(positionInput.value.trim());

            if (!itemName) {
                showStatusMessage("請選擇一個項目名稱。", 'info');
                return;
            }
            
            showStatusMessage("正在新增項目...", 'info');

            try {
                let newOrder = currentItems.length > 0 ? currentItems[currentItems.length - 1].order + 1 : 1;
                
                if (!isNaN(targetOrder) && targetOrder > 0 && targetOrder <= currentItems.length + 1) {
                    const targetIndex = targetOrder - 1;
                    
                    // 只有當目標位置不是列表的末尾時才需要移動現有項目
                    if (targetIndex < currentItems.length) {
                        // 新項目的 order 應該是目標位置的 order
                        newOrder = currentItems[targetIndex].order;
                        
                        // 執行批次操作：將後續項目的 order 遞增 1
                        for (let i = targetIndex; i < currentItems.length; i++) {
                            currentItems[i].order += 1;
                        }
                    } 
                    // 如果 targetIndex == currentItems.length (插入到末尾)，則使用 newOrder 的預設值 (max + 1)，且 batch 保持為 null，無需操作。
                }
                
                const newItem = {
                    id: 'item_' + Date.now(),
                    name: itemName,
                    order: newOrder,
                    createdAt: new Date().getTime()
                };
                
                currentItems.push(newItem);
                currentItems.sort((a, b) => a.order - b.order);
                
                // ****** 重置下拉選單 ******
                nameSelect.value = ''; // 重置選單到預設的 "請選擇一個項目"
                positionInput.value = '';
                // ************************
                
                renderList();
                showStatusMessage("項目新增成功！", 'success');

            } catch (e) {
                console.error("新增項目時發生錯誤: ", e);
                showStatusMessage("新增項目失敗，請查看控制台錯誤訊息。", 'error');
            }
        }
        window.addItem = addItem;

        /**
         * 刪除項目
         */
        async function deleteItem(id) {
            showStatusMessage("正在刪除項目...", 'info');
            const row = document.getElementById(`item-row-${id}`);
            
            if (row) {
                // 1. 加入淡出樣式
                row.classList.add('item-deleting');
                
                // 2. 延遲執行實際的刪除操作，等待動畫完成 (500ms)
                setTimeout(async () => {
                    try {
                        // 從 currentItems 中移除項目
                        const index = currentItems.findIndex(item => item.id === id);
                        if (index !== -1) {
                            currentItems.splice(index, 1);
                            
                            // 重新計算順序
                            currentItems.forEach((item, i) => {
                                item.order = i + 1;
                            });
                            
                            // 重新渲染列表
                            renderList();
                        }
                        console.log("項目刪除成功。");
                        showStatusMessage("項目刪除成功！", 'success');
                    } catch (e) {
                        console.error("刪除項目時發生錯誤: ", e);
                        showStatusMessage("刪除項目失敗，請查看控制台。", 'error');
                    }
                }, 500);
            } else {
                // 如果找不到 DOM 元素，則直接刪除
                try {
                    const index = currentItems.findIndex(item => item.id === id);
                    if (index !== -1) {
                        currentItems.splice(index, 1);
                        
                        // 重新計算順序
                        currentItems.forEach((item, i) => {
                            item.order = i + 1;
                        });
                        
                        // 重新渲染列表
                        renderList();
                    }
                    showStatusMessage("項目刪除成功！", 'success');
                } catch (e) {
                    console.error("刪除項目時發生錯誤: ", e);
                    showStatusMessage("刪除項目失敗，請查看控制台。", 'error');
                }
            }
        }
        window.deleteItem = deleteItem;

        /**
         * 上移或下移項目
         */
        async function moveItem(id, direction) {
            const currentIndex = currentItems.findIndex(item => item.id === id);
            if (currentIndex === -1) return;

            const targetIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;

            if (targetIndex < 0 || targetIndex >= currentItems.length) {
                showStatusMessage("已到達頂端或底部。", 'info');
                return;
            }

            // 交換兩個項目的順序
            const tempOrder = currentItems[currentIndex].order;
            currentItems[currentIndex].order = currentItems[targetIndex].order;
            currentItems[targetIndex].order = tempOrder;
            
            // 重新排序
            currentItems.sort((a, b) => a.order - b.order);
            
            // 重新渲染
            renderList();
            
            console.log(`項目 ${direction} 移成功。`);
        }
        window.moveItem = moveItem;
        
        /**
         * 項目 7: 批次模式切換
         */
        function toggleBatchMode() {
            isBatchMode = !isBatchMode;
            selectedItemIds.clear(); // 清空選擇狀態
            focusedItemId = null; // 清空鍵盤焦點
            
            const addButton = document.getElementById('addModeForm');
            const batchControls = document.getElementById('batchModeControls');
            const toggleButton = document.getElementById('batchModeToggle');
            
            if (isBatchMode) {
                addButton.classList.add('hidden');
                batchControls.classList.remove('hidden');
                toggleButton.classList.remove('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                toggleButton.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                toggleButton.innerHTML = `
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    返回新增模式
                `;
            } else {
                addButton.classList.remove('hidden');
                batchControls.classList.add('hidden');
                toggleButton.classList.add('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                toggleButton.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                toggleButton.innerHTML = `
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    切換到批次編輯模式
                `;
            }

            renderList(); // 重新渲染列表以顯示/隱藏核取方塊和拖曳手把
        }
        window.toggleBatchMode = toggleBatchMode;

        /**
         * 項目 7: 批次選擇
         */
        function toggleSelection(id, checked) {
            if (checked) {
                selectedItemIds.add(id);
            } else {
                selectedItemIds.delete(id);
            }
            updateBatchControls();
        }
        window.toggleSelection = toggleSelection;

        /**
         * 項目 7: 全選/取消全選
         */
        function toggleSelectAll(checked) {
            currentItems.forEach(item => {
                const checkbox = document.querySelector(`#item-row-${item.id} input[type="checkbox"]`);
                if (checkbox) {
                    checkbox.checked = checked;
                    toggleSelection(item.id, checked);
                }
            });
        }
        window.toggleSelectAll = toggleSelectAll;

        /**
         * 項目 7: 更新批次控制按鈕的狀態 (禁用/啟用/計數)
         */
        function updateBatchControls() {
            const count = selectedItemIds.size;
            const isDisabled = count === 0;

            document.getElementById('batchDeleteBtn').textContent = `批次刪除 (${count})`;
            document.getElementById('batchDeleteBtn').disabled = isDisabled;
            document.getElementById('batchMoveBtn').disabled = isDisabled;
            document.getElementById('batchUpBtn').disabled = isDisabled;
            document.getElementById('batchDownBtn').disabled = isDisabled;
        }

        /**
         * 項目 7: 批次刪除
         */
        async function batchDelete() {
            if (selectedItemIds.size === 0) return;

            showStatusMessage(`正在刪除這 ${selectedItemIds.size} 個項目...`, 'info');

            try {
                // 從 currentItems 中移除選中的項目
                currentItems = currentItems.filter(item => !selectedItemIds.has(item.id));
                
                // 重新計算順序
                currentItems.forEach((item, i) => {
                    item.order = i + 1;
                });
                
                // 重新渲染列表
                renderList();
                
                showStatusMessage("批次刪除完成！", 'success');
                selectedItemIds.clear(); // 清空選擇
                updateBatchControls();
            } catch (e) {
                console.error("批次刪除時發生錯誤: ", e);
                showStatusMessage("批次刪除失敗，請查看控制台。", 'error');
            }
        }
        window.batchDelete = batchDelete;

        /**
         * 項目 7: 批次移動 (到指定位置)
         */
        async function batchMove() {
            if (selectedItemIds.size === 0) return;
            const targetPositionInput = document.getElementById('batchMovePosition');
            let targetPosition = parseInt(targetPositionInput.value.trim());

            if (isNaN(targetPosition) || targetPosition < 1) {
                showStatusMessage("請輸入有效的目標位置 (從 1 開始)。", 'error');
                return;
            }
            
            showStatusMessage("正在執行批次移動...", 'info');

            // 1. 取得所有選中的 ID (需要保持原來的順序)
            const selectedIdsInOrder = currentItems.filter(item => selectedItemIds.has(item.id)).map(item => item.id);
            const unselectedItems = currentItems.filter(item => !selectedItemIds.has(item.id));

            // 2. 組合新的排列
            let newSequence = [];
            const insertIndex = Math.min(targetPosition - 1, unselectedItems.length);

            if (insertIndex > 0) {
                newSequence.push(...unselectedItems.slice(0, insertIndex).map(item => item.id));
            }
            newSequence.push(...selectedIdsInOrder); // 插入選中的項目
            if (insertIndex < unselectedItems.length) {
                newSequence.push(...unselectedItems.slice(insertIndex).map(item => item.id));
            }
            
            // 3. 執行批次更新
            try {
                // 重新排列 currentItems
                const newItems = [];
                newSequence.forEach((itemId, newPos) => {
                    const item = currentItems.find(i => i.id === itemId);
                    if (item) {
                        item.order = newPos + 1;
                        newItems.push(item);
                    }
                });
                
                currentItems = newItems.sort((a, b) => a.order - b.order);
                
                // 重新渲染列表
                renderList();
                
                selectedItemIds.clear(); // 清空選擇
                updateBatchControls();
                targetPositionInput.value = '';
                showStatusMessage("批次移動完成！", 'success');
            } catch (e) {
                console.error("批次移動時發生錯誤: ", e);
                showStatusMessage("批次移動失敗，請查看控制台。", 'error');
            }
        }
        window.batchMove = batchMove;

        /**
         * 項目 7: 批次向上/向下移動
         */
        async function batchShift(direction) {
            if (selectedItemIds.size === 0) return;
            
            showStatusMessage(`正在批次${direction === 'up' ? '向上' : '向下'}移動...`, 'info');

            // 取得當前所有項目的 ID 序列
            let currentIdSequence = currentItems.map(item => item.id);
            const selectedIndices = currentIdSequence
                .map((id, index) => selectedItemIds.has(id) ? index : -1)
                .filter(index => index !== -1);
            
            let moved = false;
            let newIdSequence = [...currentIdSequence];

            if (direction === 'up' && selectedIndices[0] > 0) {
                // 向上移動
                let targetIndex = selectedIndices[0] - 1;
                while (targetIndex >= 0 && selectedItemIds.has(newIdSequence[targetIndex])) {
                    targetIndex--; 
                }
                if (targetIndex >= 0) {
                    const group = selectedIndices.map(i => newIdSequence[i]);
                    for (let i = selectedIndices.length - 1; i >= 0; i--) {
                        newIdSequence.splice(selectedIndices[i], 1);
                    }
                    newIdSequence.splice(targetIndex, 0, ...group);
                    moved = true;
                }
            } else if (direction === 'down' && selectedIndices[selectedIndices.length - 1] < currentIdSequence.length - 1) {
                // 向下移動
                let targetIndex = selectedIndices[selectedIndices.length - 1] + 1;
                while (targetIndex < currentIdSequence.length && selectedItemIds.has(newIdSequence[targetIndex])) {
                    targetIndex++;
                }
                if (targetIndex < currentIdSequence.length) {
                    const group = selectedIndices.map(i => newIdSequence[i]);
                    for (let i = selectedIndices.length - 1; i >= 0; i--) {
                        newIdSequence.splice(selectedIndices[i], 1);
                    }
                    newIdSequence.splice(targetIndex - group.length + 1, 0, ...group);
                    moved = true;
                }
            }

            if (moved) {
                 try {
                    // 重新排列 currentItems
                    const newItems = [];
                    newIdSequence.forEach((itemId, newPos) => {
                        const item = currentItems.find(i => i.id === itemId);
                        if (item) {
                            item.order = newPos + 1;
                            newItems.push(item);
                        }
                    });
                    
                    currentItems = newItems.sort((a, b) => a.order - b.order);
                    
                    // 重新渲染列表
                    renderList();
                    
                    showStatusMessage("批次排序完成！", 'success');
                } catch (e) {
                    console.error("批次排序時發生錯誤: ", e);
                    showStatusMessage("批次排序失敗，請查看控制台。", 'error');
                }
            } else {
                showStatusMessage("無法再往該方向移動。", 'info');
            }
        }
        window.batchShift = batchShift;

        // 初始化應用程式
        document.addEventListener('DOMContentLoaded', function() {
            // 填充下拉選單
            populateDropdown();
            
            // 添加存檔按鈕事件監聽器
            document.getElementById('saveButton').addEventListener('click', function() {
                saveItemsToStorage();
            });
            
            // 添加取消按鈕事件監聽器
            document.getElementById('cancelButton').addEventListener('click', function() {
                cancelChanges();
            });
            
            // 設置分享連結為當前頁面URL
            document.getElementById('shareLink').value = window.location.href;
            
            // 模擬初始化
            setTimeout(() => {
                isAuthReady = true;
                document.getElementById('loadingMessage').textContent = '正在載入您的項目...';
                loadItemsFromStorage();
            }, 1500);
        });
    </script>
</body>
</html>